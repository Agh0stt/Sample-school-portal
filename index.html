<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>School Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    input, select, button { width: 100%; padding: 10px; margin: 5px 0; }
    ul { list-style: none; padding: 0; }
    li { background: #eee; margin: 3px 0; padding: 5px; border-radius: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>School Portal</h1>

    <!-- Login -->
    <div id="loginSection">
      <select id="role">
        <option value="student">Student</option>
        <option value="admin">Admin</option>
      </select>
      <div id="studentLogin">
        <input type="text" id="admissionNo" placeholder="Admission No">
        <input type="text" id="phone" placeholder="Phone">
      </div>
      <div id="adminLogin" class="hidden">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
      </div>
      <button onclick="login()">Login</button>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="hidden">
      <h2 id="studentName"></h2>
      <p id="className"></p>
      <h3>Test Results</h3>
      <ul id="testResults"></ul>
      <h3>Notices</h3>
      <ul id="notices"></ul>
      <h3>Files</h3>
      <ul id="filesList"></ul>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
      <h2>Admin Panel</h2>
      <input type="text" id="targetAdmissionNo" placeholder="Student Admission No">
      <h3>Add Test Result</h3>
      <input type="text" id="subject" placeholder="Subject">
      <input type="number" id="marks" placeholder="Marks">
      <button onclick="addTestResult()">Add Result</button>
      <h3>Add Notice</h3>
      <input type="text" id="notice" placeholder="Notice">
      <button onclick="addNotice()">Add Notice</button>
      <h3>Upload File</h3>
      <form id="fileUploadForm" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <select name="audience" id="fileAudience">
          <option value="public">Public</option>
          <option value="private">Private (Specific Student)</option>
        </select>
        <input type="text" name="admissionNo" id="fileAdmissionNo" placeholder="Student Admission No (if private)">
        <button type="submit">Upload</button>
      </form>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

<script>
document.getElementById('role').addEventListener('change', function() {
  document.getElementById('studentLogin').classList.toggle('hidden', this.value !== 'student');
  document.getElementById('adminLogin').classList.toggle('hidden', this.value !== 'admin');
});

let currentStudent = null;

function login() {
  const role = document.getElementById('role').value;
  const payload = { role };

  if (role === 'student') {
    payload.admissionNo = document.getElementById('admissionNo').value.trim();
    payload.phone = document.getElementById('phone').value.trim();
  } else {
    payload.username = document.getElementById('username').value.trim();
    payload.password = document.getElementById('password').value.trim();
  }

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) return alert(data.error || 'Login failed');
    
    document.getElementById('loginSection').classList.add('hidden');
    
    if (data.role === 'student') {
      currentStudent = data.student.admissionNo;
      showStudentDashboard(data.student);
    } else {
      document.getElementById('adminDashboard').classList.remove('hidden');
    }
  });
}

function showStudentDashboard(student) {
  document.getElementById('studentDashboard').classList.remove('hidden');
  document.getElementById('studentName').textContent = student.name;
  document.getElementById('className').textContent = student.class;

  const resultsList = document.getElementById('testResults');
  resultsList.innerHTML = '';
  student.testResults.forEach(r => {
    const li = document.createElement('li');
    li.textContent = `${r.subject}: ${r.marks}`;
    resultsList.appendChild(li);
  });

  const noticesList = document.getElementById('notices');
  noticesList.innerHTML = '';
  student.notices.forEach(n => {
    const li = document.createElement('li');
    li.textContent = n;
    noticesList.appendChild(li);
  });

  loadFiles(student.admissionNo);
}

function loadFiles(admissionNo) {
  fetch(`/api/files/${admissionNo}`)
    .then(res => res.json())
    .then(files => {
      const list = document.getElementById('filesList');
      list.innerHTML = '';
      files.forEach(f => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${f.path}" target="_blank">${f.filename}</a>`;
        list.appendChild(li);
      });
    });
}

function addTestResult() {
  const admissionNo = document.getElementById('targetAdmissionNo').value.trim();
  const subject = document.getElementById('subject').value.trim();
  const marks = parseInt(document.getElementById('marks').value, 10);

  fetch(`/api/student/${admissionNo}`)
    .then(res => res.json())
    .then(student => {
      student.testResults.push({ subject, marks });
      return fetch('/api/student/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(student)
      });
    })
    .then(res => res.json())
    .then(() => alert('Result added!'));
}

function addNotice() {
  const admissionNo = document.getElementById('targetAdmissionNo').value.trim();
  const notice = document.getElementById('notice').value.trim();

  fetch(`/api/student/${admissionNo}`)
    .then(res => res.json())
    .then(student => {
      student.notices.push(notice);
      return fetch('/api/student/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(student)
      });
    })
    .then(res => res.json())
    .then(() => alert('Notice added!'));
}

document.getElementById('fileUploadForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch('/api/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => alert(data.message));
});

function logout() {
  location.reload();
}
</script>
</body>
</html>
